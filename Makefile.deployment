# ============================================================================
# Universal Deployment Makefile
# ============================================================================
# This Makefile contains universal deployment commands for Next.js/React projects
# with GitHub Actions and Netlify deployment automation.
#
# ğŸš€ GETTING STARTED:
# 
# 1. COPY THIS FILE to your new project root:
#    cp Makefile.deployment /path/to/your/project/
#
# 2. GENERATE A PROJECT MAKEFILE:
#    cd /path/to/your/project/
#    make init-project
#    # This creates a main Makefile that includes Makefile.deployment
#
# 3. CUSTOMIZE YOUR PROJECT:
#    # Edit the generated Makefile to customize:
#    # - UI_DIR (default: ui/website)
#    # - Build commands specific to your project
#    # - Test commands
#    # - Development commands
#
# 4. SET UP DEPLOYMENT:
#    make setup-githubactions-netlifydeployment
#    # This will guide you through GitHub CLI and Netlify setup
#
# 5. START DEVELOPING:
#    make help           # See all available commands
#    make dev            # Start development server
#    make build          # Build your project
#    make test           # Run tests
#    make deploy-website # Deploy to production
#
# ============================================================================
# ADVANCED USAGE:
# ============================================================================
# 
# Include this file in your main Makefile:
#    include Makefile.deployment
#
# Override variables as needed in your main Makefile:
#    UI_DIR = ui/my-app
#    NETLIFY_CONFIG = netlify.toml
#    GITHUB_WORKFLOW = .github/workflows/deploy.yml
#
# Available deployment commands:
#    make init-project                 - Generate project Makefile template
#    make setup-githubcli              - Install and authenticate GitHub CLI
#    make setup-githubcli-ssh          - Authenticate GitHub CLI with SSH
#    make setup-netlify                - Setup Netlify CLI
#    make setup-github-secrets         - Configure GitHub repository secrets
#    make setup-githubactions-netlifydeployment - Full setup automation
#    make validate-deployment-setup    - Validate complete deployment config
#    make deploy-website               - Deploy to Netlify production
#    make deploy-preview               - Create Netlify preview deployment
#    make check-github-secrets         - Verify GitHub repository secrets
#    make test-build                   - Test build locally before deployment
#    make deploy-status                - Check deployment status
#    make deployment-help              - Show deployment-specific help
#
# Requirements:
# - Node.js project with package.json in $(UI_DIR)
# - netlify.toml configuration file
# - GitHub Actions workflow file (optional)
# ============================================================================

# Default configuration - override these in your main Makefile
UI_DIR ?= ui/website
NETLIFY_CONFIG ?= netlify.toml
GITHUB_WORKFLOW ?= .github/workflows/deploy.yml

# ============================================================================
# Deployment Help
# ============================================================================
.PHONY: deployment-help
deployment-help:
	@echo "Universal Deployment Commands"
	@echo "============================"
	@echo ""
	@echo "ğŸš€ Getting Started (New Project):"
	@echo "  1. Copy Makefile.deployment to your project root"
	@echo "  2. make init-project         - Generate main Makefile template"
	@echo "  3. Customize generated Makefile for your project structure"
	@echo "  4. make setup-githubactions-netlifydeployment - Complete deployment setup"
	@echo "  5. make help                 - See all available commands"
	@echo ""
	@echo "ğŸ“‹ Project Setup Commands:"
	@echo "  make init-project            - Generate project Makefile template"
	@echo "  make deployment-help         - Show this help (deployment-specific)"
	@echo ""
	@echo "ğŸ”§ Deployment Setup Commands:"
	@echo "  make setup-githubactions-netlifydeployment - Complete GitHub Actions + Netlify setup"
	@echo "  make validate-deployment-setup             - Validate your deployment configuration"
	@echo ""
	@echo "ğŸ”§ Individual Setup Commands:"
	@echo "  make setup-githubcli         - Install and authenticate GitHub CLI"
	@echo "  make setup-githubcli-ssh     - Authenticate GitHub CLI with existing SSH keys"
	@echo "  make setup-netlify           - Setup Netlify CLI and authentication"
	@echo "  make setup-github-secrets    - Set GitHub repository secrets for deployment"
	@echo "  make check-github-secrets    - Verify GitHub repository secrets"
	@echo ""
	@echo "ğŸš€ Deployment Commands:"
	@echo "  make deploy-website          - Deploy website to Netlify production"
	@echo "  make deploy-preview          - Create Netlify preview deployment"
	@echo "  make test-build              - Test build locally before deployment"
	@echo "  make deploy-status           - Check deployment status"
	@echo ""
	@echo "ğŸ”§ Configuration:"
	@echo "  UI_DIR = $(UI_DIR)"
	@echo "  NETLIFY_CONFIG = $(NETLIFY_CONFIG)"
	@echo "  GITHUB_WORKFLOW = $(GITHUB_WORKFLOW)"
	@echo ""
	@echo "ğŸ’¡ Override variables in your main Makefile as needed."
	@echo "ğŸ’¡ See the header of this file for detailed getting started instructions."
	@echo ""

# ============================================================================
# GitHub CLI Setup
# ============================================================================
.PHONY: setup-githubcli setup-githubcli-ssh

setup-githubcli:
	@echo "ğŸ“¦ Installing and setting up GitHub CLI..."
	@if ! command -v gh >/dev/null 2>&1; then \
		echo "ğŸ”§ Installing GitHub CLI..."; \
		if command -v apt >/dev/null 2>&1; then \
			echo "Using apt package manager..."; \
			curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg; \
			sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg; \
			echo "deb [arch=$$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null; \
			sudo apt update && sudo apt install -y gh; \
		elif command -v brew >/dev/null 2>&1; then \
			echo "Using brew package manager..."; \
			brew install gh; \
		else \
			echo "Installing GitHub CLI binary directly..."; \
			curl -L https://github.com/cli/cli/releases/download/v2.40.1/gh_2.40.1_linux_amd64.tar.gz | tar -xz; \
			sudo mv gh_2.40.1_linux_amd64/bin/gh /usr/local/bin/; \
			rm -rf gh_2.40.1_linux_amd64; \
		fi; \
		echo "âœ… GitHub CLI installed successfully"; \
	else \
		echo "âœ… GitHub CLI already installed"; \
	fi
	@echo ""
	@echo "ğŸ”‘ Checking GitHub CLI authentication..."
	@if ! gh auth status >/dev/null 2>&1; then \
		echo "Setting up GitHub CLI authentication with SSH..."; \
		echo "ğŸ’¡ Using SSH authentication since you already have SSH keys configured"; \
		gh auth login --git-protocol ssh --hostname github.com; \
	else \
		echo "âœ… Already authenticated with GitHub CLI"; \
	fi
	@echo ""
	@echo "âœ… GitHub CLI setup complete!"
	@echo "ğŸ’¡ You can now use 'gh' commands or run 'make setup-github-secrets'"

setup-githubcli-ssh:
	@echo "ğŸ“¦ Setting up GitHub CLI with SSH authentication..."
	@if ! command -v gh >/dev/null 2>&1; then \
		echo "âŒ GitHub CLI not installed"; \
		echo "ğŸ’¡ Run 'make setup-githubcli' first"; \
		exit 1; \
	fi
	@echo "ğŸ”‘ Authenticating with SSH (will use your existing SSH keys)..."
	@gh auth login --git-protocol ssh --hostname github.com --skip-ssh-key
	@echo "âœ… GitHub CLI authenticated with SSH!"
	@echo "ğŸ’¡ Your existing SSH keys will be used for Git operations"

# ============================================================================
# Netlify Setup
# ============================================================================
.PHONY: setup-netlify

setup-netlify:
	@echo "ğŸ”§ Setting up Netlify CLI..."
	@if ! command -v netlify >/dev/null 2>&1; then \
		echo "Installing Netlify CLI..."; \
		npm install -g netlify-cli; \
	else \
		echo "âœ… Netlify CLI already installed"; \
	fi
	@echo "ğŸ”‘ Please run 'netlify login' to authenticate"
	@echo "ğŸ  Then run 'netlify link' in the project root to connect to your site"
	@echo "ğŸ’¡ Or set NETLIFY_SITE_ID environment variable manually"

# ============================================================================
# GitHub Secrets Management
# ============================================================================
.PHONY: setup-github-secrets check-github-secrets

setup-github-secrets:
	@echo "ğŸ” Setting up GitHub secrets for automatic deployment..."
	@echo "This will read Netlify configuration and set GitHub repository secrets"
	@echo ""
	@if ! command -v gh >/dev/null 2>&1; then \
		echo "âŒ GitHub CLI not installed"; \
		echo "ğŸ’¡ Install with: brew install gh (macOS) or https://cli.github.com/"; \
		exit 1; \
	fi
	@if ! gh auth status >/dev/null 2>&1; then \
		echo "ğŸ”‘ Please authenticate with GitHub CLI first:"; \
		echo "  gh auth login"; \
		exit 1; \
	fi
	@if [ ! -f .netlify/state.json ]; then \
		echo "âŒ Netlify not linked to this directory"; \
		echo "ğŸ’¡ Run 'netlify link' first"; \
		exit 1; \
	fi
	@echo "ğŸ“ Extracting Netlify Site ID..."
	@SITE_ID=$$(jq -r '.siteId' .netlify/state.json 2>/dev/null || echo ""); \
	if [ -z "$$SITE_ID" ] || [ "$$SITE_ID" = "null" ]; then \
		echo "âŒ Could not extract site ID from .netlify/state.json"; \
		echo "ğŸ’¡ Try running 'netlify status' to verify the link"; \
		exit 1; \
	fi; \
	echo "âœ… Found Site ID: $$SITE_ID"; \
	echo "ğŸ”‘ Setting NETLIFY_SITE_ID secret..."; \
	echo "$$SITE_ID" | gh secret set NETLIFY_SITE_ID; \
	echo "âœ… NETLIFY_SITE_ID secret set successfully"
	@echo ""
	@echo "ğŸ”‘ Setting NETLIFY_AUTH_TOKEN secret..."
	@echo "ğŸ’¡ You need to create a personal access token at:"
	@echo "   https://app.netlify.com/user/applications#personal-access-tokens"
	@echo ""
	@read -p "Enter your Netlify personal access token: " token; \
	if [ -z "$$token" ]; then \
		echo "âŒ No token provided"; \
		exit 1; \
	fi; \
	echo "$$token" | gh secret set NETLIFY_AUTH_TOKEN; \
	echo "âœ… NETLIFY_AUTH_TOKEN secret set successfully"
	@echo ""
	@echo "ğŸ‰ GitHub secrets configured! Your repository is now ready for automatic deployment."
	@echo "ğŸ’¡ Push to main branch to trigger automatic deployment to production."

check-github-secrets:
	@echo "ğŸ” Checking GitHub repository secrets..."
	@if ! command -v gh >/dev/null 2>&1; then \
		echo "âŒ GitHub CLI not installed"; \
		exit 1; \
	fi
	@if ! gh auth status >/dev/null 2>&1; then \
		echo "âŒ Not authenticated with GitHub CLI"; \
		echo "ğŸ’¡ Run 'gh auth login' first"; \
		exit 1; \
	fi
	@echo "ğŸ“‹ Repository secrets:"
	@gh secret list

# ============================================================================
# Deployment Validation
# ============================================================================
.PHONY: validate-deployment-setup

validate-deployment-setup:
	@echo "ğŸ” Validating GitHub Actions + Netlify deployment setup..."
	@echo ""
	@echo "ğŸ“‹ Checking prerequisites:"
	@echo ""
	@echo "1ï¸âƒ£ GitHub CLI Installation:"
	@if command -v gh >/dev/null 2>&1; then \
		echo "âœ… GitHub CLI is installed ($$(gh --version | head -1))"; \
	else \
		echo "âŒ GitHub CLI not found"; \
		echo "ğŸ’¡ Run: make setup-githubcli"; \
		echo ""; \
	fi
	@echo ""
	@echo "2ï¸âƒ£ GitHub CLI Authentication:"
	@if command -v gh >/dev/null 2>&1; then \
		if gh auth status >/dev/null 2>&1; then \
			echo "âœ… GitHub CLI is authenticated"; \
			echo "ğŸ“‹ Logged in as: $$(gh api user --jq .login 2>/dev/null || echo 'Unknown')"; \
		else \
			echo "âŒ GitHub CLI not authenticated"; \
			echo "ğŸ’¡ Run: gh auth login"; \
		fi; \
	else \
		echo "â­ï¸  Skipping (GitHub CLI not installed)"; \
	fi
	@echo ""
	@echo "3ï¸âƒ£ Netlify Configuration:"
	@if [ -f .netlify/state.json ]; then \
		SITE_ID=$$(jq -r '.siteId' .netlify/state.json 2>/dev/null || echo ""); \
		if [ -n "$$SITE_ID" ] && [ "$$SITE_ID" != "null" ]; then \
			echo "âœ… Netlify project is linked"; \
			echo "ğŸ“‹ Site ID: $$SITE_ID"; \
		else \
			echo "âŒ Invalid Netlify configuration"; \
			echo "ğŸ’¡ Run: netlify link"; \
		fi; \
	else \
		echo "âŒ Netlify not linked to this directory"; \
		echo "ğŸ’¡ Run: netlify login && netlify link"; \
	fi
	@echo ""
	@echo "4ï¸âƒ£ GitHub Repository Secrets:"
	@if command -v gh >/dev/null 2>&1 && gh auth status >/dev/null 2>&1; then \
		echo "Checking repository secrets..."; \
		SECRETS=$$(gh secret list --json name --jq '.[].name' 2>/dev/null || echo ""); \
		if echo "$$SECRETS" | grep -q "NETLIFY_AUTH_TOKEN"; then \
			echo "âœ… NETLIFY_AUTH_TOKEN is set"; \
		else \
			echo "âŒ NETLIFY_AUTH_TOKEN missing"; \
		fi; \
		if echo "$$SECRETS" | grep -q "NETLIFY_SITE_ID"; then \
			echo "âœ… NETLIFY_SITE_ID is set"; \
		else \
			echo "âŒ NETLIFY_SITE_ID missing"; \
		fi; \
		if [ -z "$$SECRETS" ]; then \
			echo "âŒ No repository secrets found"; \
		fi; \
		echo "ğŸ’¡ Run: make setup-github-secrets"; \
	else \
		echo "â­ï¸  Skipping (GitHub CLI not ready)"; \
	fi
	@echo ""
	@echo "5ï¸âƒ£ GitHub Actions Workflow:"
	@if [ -f "$(GITHUB_WORKFLOW)" ]; then \
		echo "âœ… GitHub Actions workflow exists"; \
	else \
		echo "âŒ GitHub Actions workflow missing"; \
		echo "ğŸ’¡ Workflow should be at $(GITHUB_WORKFLOW)"; \
	fi
	@echo ""
	@echo "6ï¸âƒ£ Netlify Configuration:"
	@if [ -f "$(NETLIFY_CONFIG)" ]; then \
		echo "âœ… $(NETLIFY_CONFIG) configuration exists"; \
	else \
		echo "âŒ $(NETLIFY_CONFIG) missing"; \
	fi
	@echo ""
	@echo "ğŸ“Š Setup Summary:"
	@ALL_GOOD=true; \
	if ! command -v gh >/dev/null 2>&1; then ALL_GOOD=false; fi; \
	if command -v gh >/dev/null 2>&1 && ! gh auth status >/dev/null 2>&1; then ALL_GOOD=false; fi; \
	if [ ! -f .netlify/state.json ]; then ALL_GOOD=false; fi; \
	if [ ! -f "$(GITHUB_WORKFLOW)" ]; then ALL_GOOD=false; fi; \
	if [ ! -f "$(NETLIFY_CONFIG)" ]; then ALL_GOOD=false; fi; \
	if [ "$$ALL_GOOD" = "true" ]; then \
		echo "ğŸ‰ All components are configured!"; \
		echo "ğŸ’¡ Push to main branch to test automatic deployment"; \
	else \
		echo "âš ï¸  Some components need attention"; \
		echo "ğŸ’¡ Follow the suggestions above to complete setup"; \
	fi

# ============================================================================
# Deployment Commands
# ============================================================================
.PHONY: deploy-website deploy-preview deploy-status test-build

deploy-website:
	@echo "ğŸš€ Deploying website to Netlify production..."
	@echo "Using $(NETLIFY_CONFIG) configuration for build and deploy"
	@if [ ! -f .netlify/state.json ] && [ -z "$${NETLIFY_SITE_ID}" ]; then \
		echo "âŒ Project not linked and NETLIFY_SITE_ID not set"; \
		echo "ğŸ’¡ Run 'netlify link' or set NETLIFY_SITE_ID environment variable"; \
		exit 1; \
	fi
	@if [ -n "$${NETLIFY_AUTH_TOKEN}" ]; then \
		echo "ğŸ”‘ Using NETLIFY_AUTH_TOKEN for authentication"; \
	fi
	netlify deploy --prod

deploy-preview:
	@echo "ğŸ‘€ Creating preview deployment..."
	@echo "Using $(NETLIFY_CONFIG) configuration for build and deploy"
	@if [ ! -f .netlify/state.json ] && [ -z "$${NETLIFY_SITE_ID}" ]; then \
		echo "âŒ Project not linked and NETLIFY_SITE_ID not set"; \
		echo "ğŸ’¡ Run 'netlify link' or set NETLIFY_SITE_ID environment variable"; \
		exit 1; \
	fi
	@if [ -n "$${NETLIFY_AUTH_TOKEN}" ]; then \
		echo "ğŸ”‘ Using NETLIFY_AUTH_TOKEN for authentication"; \
	fi
	netlify deploy

deploy-status:
	@echo "ğŸ“Š Checking deployment status..."
	netlify status

test-build:
	@echo "ğŸ§ª Testing build locally before deployment..."
	cd $(UI_DIR) && npm ci
	cd $(UI_DIR) && npm run build
	@echo "âœ… Build successful! Ready for deployment."

# ============================================================================
# Automated Setup
# ============================================================================
.PHONY: setup-githubactions-netlifydeployment

setup-githubactions-netlifydeployment: setup-githubcli
	@echo "ğŸš€ Setting up GitHub Actions with Netlify deployment automation..."
	@echo ""
	@echo "ğŸ”§ Setting up GitHub repository secrets..."
	@$(MAKE) setup-github-secrets
	@echo ""
	@echo "ğŸ‰ GitHub Actions Netlify deployment is now configured!"
	@echo "ğŸ’¡ Push to main branch to trigger automatic deployment to production"
	@echo "ğŸ’¡ Create PR to trigger preview deployments"

# ============================================================================
# Project Template Generation
# ============================================================================
.PHONY: init-project

define MAKEFILE_TEMPLATE
# ============================================================================
# Project Makefile
# ============================================================================
# This is a template Makefile generated by Makefile.deployment
# 
# ğŸ”§ CUSTOMIZE THIS FILE:
# - Update PROJECT_NAME with your project name
# - Update UI_DIR to match your project structure
# - Add project-specific build, test, and development commands
#
# ğŸš€ QUICK START:
# make help           - Show all available commands
# make dev            - Start development server
# make build          - Build your project
# make test           - Run tests
# make deploy-website - Deploy to production
# ============================================================================

# Project configuration - CUSTOMIZE THESE
PROJECT_NAME ?= my-nextjs-project
UI_DIR ?= ui/website
NETLIFY_CONFIG ?= netlify.toml
GITHUB_WORKFLOW ?= .github/workflows/deploy.yml

# Include universal deployment commands
include Makefile.deployment

# Default target
.PHONY: all
all: help

# ============================================================================
# Help
# ============================================================================
.PHONY: help
help:
	@echo "$$(PROJECT_NAME) - Available Make Targets"
	@echo "======================================="
	@echo ""
	@echo "ğŸš€ Quick Start:"
	@echo "  make dev                - Start development server"
	@echo "  make build              - Build the project"
	@echo "  make test               - Run tests"
	@echo "  make deploy-website     - Deploy to production"
	@echo ""
	@echo "ğŸ’¡ Run 'make deployment-help' for deployment-specific commands"
	@echo ""

# ============================================================================
# Development Commands
# ============================================================================
.PHONY: dev build test clean deps

dev:
	@echo "ğŸš€ Starting development server..."
	cd $$(UI_DIR) && npm run dev

build:
	@echo "ğŸ”¨ Building $$(PROJECT_NAME)..."
	cd $$(UI_DIR) && npm run build

test:
	@echo "ğŸ§ª Running tests..."
	cd $$(UI_DIR) && npm test

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	cd $$(UI_DIR) && rm -rf .next build dist node_modules/.cache

deps:
	@echo "ğŸ“¦ Installing dependencies..."
	cd $$(UI_DIR) && npm install
endef

export MAKEFILE_TEMPLATE

init-project:
	@echo "ğŸš€ Initializing new project with Makefile.deployment integration..."
	@echo ""
	@if [ -f Makefile ]; then \
		echo "âš ï¸  Makefile already exists!"; \
		echo "ğŸ’¡ Backup existing Makefile before continuing (y/n)?"; \
		read -r confirm; \
		if [ "$$confirm" = "y" ] || [ "$$confirm" = "Y" ]; then \
			mv Makefile Makefile.backup; \
			echo "âœ… Backed up existing Makefile to Makefile.backup"; \
		else \
			echo "âŒ Aborting to avoid overwriting existing Makefile"; \
			exit 1; \
		fi; \
	fi
	@echo "ğŸ“ Creating main Makefile template..."
	@echo "$$MAKEFILE_TEMPLATE" > Makefile
	@echo "âœ… Main Makefile created successfully!"
	@echo ""
	@echo "ğŸ“ Next steps:"
	@echo "1. Edit the new Makefile to customize PROJECT_NAME and UI_DIR"
	@echo "2. Run 'make help' to see all available commands"
	@echo "3. Run 'make deps' to install dependencies"
	@echo "4. Run 'make dev' to start development"
	@echo "5. Run 'make setup-githubactions-netlifydeployment' to setup deployment"
	@echo ""
	@echo "ğŸ’¡ The Makefile has been created with sensible defaults"
	@echo "ğŸ’¡ See the header of Makefile.deployment for more information"

# ============================================================================
# Phony Targets
# ============================================================================
.PHONY: setup-githubcli setup-githubcli-ssh setup-netlify setup-github-secrets 
.PHONY: check-github-secrets validate-deployment-setup deploy-website deploy-preview
.PHONY: deploy-status test-build setup-githubactions-netlifydeployment deployment-help
.PHONY: init-project